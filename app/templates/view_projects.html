{% extends "base.html" %}

{% block title %}View Projects{% endblock %}

{% block extra_css %}
<!-- Link to the CSS file specifically for view_projects.html -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/viewproject.css') }}">
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<!-- DataTables Buttons CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header d-flex justify-content-between align-items-center border-0">
                    <h1 class="h3 mb-0">Projects Overview</h1>
                    <div class="d-flex align-items-center">
                        {% if current_user.Role in ['Admin', 'Manager'] %}
                            <a href="{{ url_for('main.add_project') }}" class="btn btn-primary btn-sm me-2"><i class="fas fa-plus me-1"></i> Add Project</a>
                            <!-- Upload Excel Button -->
                            <button type="button" class="btn btn-info btn-sm me-2" data-bs-toggle="modal" data-bs-target="#uploadExcelModal">
                                <i class="fas fa-upload me-1"></i> Upload Projects
                            </button>
                        {% endif %}
                        <a href="{{ url_for('main.dashboard') }}" class="btn btn-secondary btn-sm me-2"><i class="fas fa-arrow-left me-1"></i> Back to Dashboard</a>
                        <!-- Export Dropdown -->
                        <div class="dropdown">
                            <button class="btn btn-success btn-sm dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-download me-1"></i> Export
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                                <li><a class="dropdown-item" href="#" data-export="copy">Copy</a></li>
                                <li><a class="dropdown-item" href="#" data-export="csv">CSV</a></li>
                                <li><a class="dropdown-item" href="#" data-export="excel">Excel</a></li>
                                <li><a class="dropdown-item" href="#" data-export="pdf">PDF</a></li>
                                <li><a class="dropdown-item" href="#" data-export="print">Print</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }} alert-dismissible fade show mb-3" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    <div class="table-wrapper">
                        <div class="table-header d-flex justify-content-between align-items-center mb-3">
                            <div class="dataTables_filter"></div> <!-- Placeholder for DataTables search -->
                        </div>
                        <table id="projectsTable" class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Project ID</th>
                                    <th>Implementing Agency</th>
                                    <th>Program</th>
                                    <th>Project Name</th>
                                    <th>County</th>
                                    <th>Constituency</th>
                                    <th>Ward</th>
                                    <th>GPS Coordinates</th>
                                    <th>Project Type</th>
                                    <th>Project Location</th>
                                    <th>Scope of Works</th>
                                    <th>Intake Capacity (m続)</th>
                                    <th>Treatment Capacity (m続)</th>
                                    <th>Storage Capacity (m続)</th>
                                    <th>Treated Water Mains (km)</th>
                                    <th>Distribution Lines (km)</th>
                                    <th>Water Kiosks</th>
                                    <th>Connections</th>
                                    <th>Wastewater Capacity (m続)</th>
                                    <th>Target Areas</th>
                                    <th>Target Households</th>
                                    <th>Target Population</th>
                                    <th>Contractor</th>
                                    <th>Consultant</th>
                                    <th>Start Date</th>
                                    <th>Planned End Date</th>
                                    <th>Actual End Date</th>
                                    <th>Progress (%)</th>
                                    <th>Total Contract Sum (KES)</th>
                                    <th>Cumulative Expenditure (KES)</th>
                                    <th>Outstanding Cost (KES)</th>
                                    <th>Exchequer Releases (KES)</th>
                                    <th>Pending Bills (KES)</th>
                                    <th>FY2021-22 Budget</th>
                                    <th>FY2021-23 Budget</th>
                                    <th>FY2022-23 Budget</th>
                                    <th>FY2022-24 Budget</th>
                                    <th>FY2023-24 Budget</th>
                                    <th>FY2023-25 Budget</th>
                                    <th>FY2024-25 Allocation</th>
                                    <th>FY2024-26 Allocation</th>
                                    <th>Source of Funds</th>
                                    <th>Funding Amount (KES)</th>
                                    <th>Impacts</th>
                                    <th>Challenges</th>
                                    <th>Remarks</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for project in projects %}
                                <tr>
                                    <td>{{ project.ProjectID }}</td>
                                    <td>{{ project.ImplementingAgency }}</td>
                                    <td>{{ project.Program }}</td>
                                    <td>{{ project.ProjectName }}</td>
                                    <td>{{ project.county.CountyName if project.county else '' }}</td>
                                    <td>{{ project.constituency.ConstituencyName if project.constituency else '' }}</td>
                                    <td>{{ project.ward.WardName if project.ward else '' }}</td>
                                    <td>{{ project.GPSCoordinates }}</td>
                                    <td>{{ project.ProjectType }}</td>
                                    <td>{{ project.ProjectLocation }}</td>
                                    <td class="truncate" data-full-text="{{ project.ScopeOfWorks }}">{{ project.ScopeOfWorks }}</td>
                                    <td>{{ project.IntakeCapacity_m3 }}</td>
                                    <td>{{ project.TreatmentCapacity_m3 }}</td>
                                    <td>{{ project.StorageCapacity_m3 }}</td>
                                    <td>{{ project.TreatedWaterMains_km }}</td>
                                    <td>{{ project.DistributionLines_km }}</td>
                                    <td>{{ project.NumberOfWaterKiosks }}</td>
                                    <td>{{ project.NumberOfConnections }}</td>
                                    <td>{{ project.WastewaterCapacity_m3 }}</td>
                                    <td>{{ project.TargetAreas }}</td>
                                    <td>{{ project.TargetBeneficiaries_Households }}</td>
                                    <td>{{ project.TargetBeneficiaries_Population }}</td>
                                    <td>{{ project.Contractor }}</td>
                                    <td>{{ project.Consultant }}</td>
                                    <td>{{ project.StartDate }}</td>
                                    <td>{{ project.PlannedEndDate }}</td>
                                    <td>{{ project.ActualEndDate }}</td>
                                    <td>{{ project.ProgressPercentage }}</td>
                                    <td>{{ "{:,.2f}".format(project.TotalContractSum_KES) if project.TotalContractSum_KES else '' }}</td>
                                    <td>{{ "{:,.2f}".format(project.CumulativeExpenditure_KES) if project.CumulativeExpenditure_KES else '' }}</td>
                                    <td>{{ "{:,.2f}".format(project.OutstandingCost_KES) if project.OutstandingCost_KES else '' }}</td>
                                    <td>{{ "{:,.2f}".format(project.ExchequerReleases_KES) if project.ExchequerReleases_KES else '' }}</td>
                                    <td>{{ "{:,.2f}".format(project.SumOfPendingBills_KES) if project.SumOfPendingBills_KES else '' }}</td>
                                    <td>{{ "{:,.2f}".format(project.ApprovedBudgetFY2021_22) if project.ApprovedBudgetFY2021_22 else '' }}</td>
                                    <td>{{ "{:,.2f}".format(project.ApprovedBudgetFY2021_23) if project.ApprovedBudgetFY2021_23 else '' }}</td>
                                    <td>{{ "{:,.2f}".format(project.ApprovedBudgetFY2022_23) if project.ApprovedBudgetFY2022_23 else '' }}</td>
                                    <td>{{ "{:,.2f}".format(project.ApprovedBudgetFY2022_24) if project.ApprovedBudgetFY2022_24 else '' }}</td>
                                    <td>{{ "{:,.2f}".format(project.ApprovedBudgetFY2023_24) if project.ApprovedBudgetFY2023_24 else '' }}</td>
                                    <td>{{ "{:,.2f}".format(project.ApprovedBudgetFY2023_25) if project.ApprovedBudgetFY2023_25 else '' }}</td>
                                    <td>{{ "{:,.2f}".format(project.BudgetAllocationFY2024_25) if project.BudgetAllocationFY2024_25 else '' }}</td>
                                    <td>{{ "{:,.2f}".format(project.BudgetAllocationFY2024_26) if project.BudgetAllocationFY2024_26 else '' }}</td>
                                    <td>{{ project.SourceOfFunds }}</td>
                                    <td>{{ "{:,.2f}".format(project.FundingAmount) if project.FundingAmount else '0.00' }}</td>
                                    <td class="truncate" data-full-text="{{ project.ImpactsOfTheProject }}">{{ project.ImpactsOfTheProject }}</td>
                                    <td class="truncate" data-full-text="{{ project.KeyChallenges }}">{{ project.KeyChallenges }}</td>
                                    <td class="truncate" data-full-text="{{ project.Remarks }}">{{ project.Remarks }}</td>
                                    <td>
                                        {% if current_user.Role == 'Admin' %}
                                            <a href="{{ url_for('main.edit_project', project_id=project.ProjectID) }}" class="btn btn-sm btn-primary"><i class="fas fa-edit"></i> Edit</a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Excel Modal -->
<div class="modal fade" id="uploadExcelModal" tabindex="-1" aria-labelledby="uploadExcelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadExcelModalLabel">Upload Projects from Excel</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadExcelForm" method="POST" action="{{ url_for('main.upload_projects_excel') }}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="excelFile" class="form-label">Select Excel File (.xlsx or .xls)</label>
                        <input type="file" class="form-control" id="excelFile" name="excel_file" accept=".xlsx, .xls" required>
                        <small class="form-text text-muted">
                            Upload a raw data file with these required columns in the first row: ProjectName, CountyID, SourceOfFunds, FundingAmount (case-insensitive). 
                            ProjectID is auto-generated by the system and should not be included in the file. 
                            Example: 
                            <pre>ProjectName | CountyID | SourceOfFunds | FundingAmount
Water Supply Project | 1 | GoK | 5000000</pre>
                            Do <strong>not</strong> upload an export from the "View Projects" page (e.g., "View Projects.xlsx").
                        </small>
                    </div>
                    <button type="submit" class="btn btn-primary" id="uploadBtn">
                        <span id="uploadText">Upload</span>
                        <span class="spinner-border spinner-border-sm d-none" id="uploadSpinner" role="status" aria-hidden="true"></span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables JavaScript -->
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<!-- DataTables Buttons JavaScript -->
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<!-- JSZip for Excel export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<!-- pdfmake for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<!-- Buttons HTML5 export -->
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<!-- Buttons Print export -->
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<!-- Custom Script -->
<script>
    $(document).ready(function() {
        var table = $('#projectsTable').DataTable({
            scrollX: true, // Enable horizontal scrolling within the table
            scrollCollapse: true, // Adjust table height if content is less
            paging: true,
            pageLength: 10,
            lengthMenu: [10, 25, 50, 100],
            searching: true,
            ordering: true,
            dom: '<"table-header"f>t<"table-footer"ip>', // No buttons in DOM layout
            buttons: [
                { extend: 'copy', className: 'copy-btn' },
                { extend: 'csv', className: 'csv-btn' },
                { extend: 'excel', className: 'excel-btn' },
                {
                    extend: 'pdf',
                    className: 'pdf-btn',
                    orientation: 'landscape',
                    pageSize: 'A3',
                    exportOptions: {
                        columns: ':visible' // Export only visible columns
                    }
                },
                { extend: 'print', className: 'print-btn' }
            ],
            columnDefs: [
                { targets: '_all', className: 'text-wrap' },
                { targets: [10, 43, 44, 45], className: 'truncate' }
            ]
        });

        // Truncate text initially
        $('.truncate').each(function() {
            var $this = $(this);
            var fullText = $this.data('full-text') || '';
            if (fullText) {
                $this.text(fullText.split(' ').slice(0, 3).join(' ') + '...');
            }
        });

        // Click to expand truncated text
        $('.truncate').on('click', function() {
            var $this = $(this);
            if ($this.hasClass('expanded')) {
                $this.removeClass('expanded').text($this.data('full-text').split(' ').slice(0, 3).join(' ') + '...');
            } else {
                $this.addClass('expanded').text($this.data('full-text'));
            }
        });

        // Trigger export actions via dropdown items
        $('.dropdown-item[data-export]').on('click', function(e) {
            e.preventDefault();
            var exportType = $(this).data('export');
            // Map export type to button index
            var buttonIndex;
            switch (exportType) {
                case 'copy':
                    buttonIndex = 0;
                    break;
                case 'csv':
                    buttonIndex = 1;
                    break;
                case 'excel':
                    buttonIndex = 2;
                    break;
                case 'pdf':
                    buttonIndex = 3;
                    break;
                case 'print':
                    buttonIndex = 4;
                    break;
                default:
                    return; // Invalid export type
            }
            // Trigger the corresponding DataTables button
            table.button(buttonIndex).trigger();
        });

        // Handle form submission with feedback
        $('#uploadExcelForm').on('submit', function(e) {
            const fileInput = $('#excelFile')[0];
            if (!fileInput.files.length) {
                e.preventDefault();
                alert('Please select a file.');
                return;
            }
            const fileName = fileInput.files[0].name;
            if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
                e.preventDefault();
                alert('Please upload an Excel file (.xlsx or .xls).');
                return;
            }
            // Show loading spinner
            $('#uploadText').text('Uploading...');
            $('#uploadSpinner').removeClass('d-none');
            $('#uploadBtn').prop('disabled', true);
        });
    });
</script>
{% endblock %}